<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<title>Developing beam optics for the future of BESSY II</title>

	<link rel="stylesheet" href="reveal.js/css/reveal.css">
	<link rel="stylesheet" href="custom-theme.css">
	<!-- <link rel="stylesheet" href="reveal.js/css/theme/white.css"> -->
	<link rel="stylesheet" href="custom.css">

	<!-- Theme used for syntax highlighting of code -->
	<link rel="stylesheet" href="reveal.js/lib/css/zenburn.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/googlecode.min.css">

	<!-- Printing and PDF exports -->
	<script>
		var link = document.createElement('link');
		link.rel = 'stylesheet';
		link.type = 'text/css';
		link.href = window.location.search.match(/print-pdf/gi) ? 'pdf-custom.css' : 'reveal.js/css/print/paper.css';
		document.getElementsByTagName('head')[0].appendChild(link);
	</script>
</head>

<body>
	<div class="reveal">
		<div class="slides">

			<section class="titlepage">
				<div class="grid-titlepage">
					<div class="grid g11 stretch">
						<img src="images/layout/hzb_logo.svg" width="240px">
						<img src="images/layout/hu_logo.svg" width="240px">
					</div>
					<div style="text-align: center;">
						<h1>Optimization of the BESSY II optics for the VSR project</h1>
						<h3 style="text-align: center;">Increasing the available installation length for the VSR cavity</h3>
					</div>
					<p style="font-size: 24pt;">by Felix Andreas</p>
				</div>
			</section>

			<section class="center">
				<h1>Motivation</h1>
			</section>

			<section class="title">
				<h1>BESSY II - A third generation light source</h1>
				<div class=" grow grid g32">
					<img src="images/layout/bessy_luft.jpg" width="100%">
					<div class="flex-col space-evenly">
						<ul>
							<li>Third generation synchrotron light source<br>from THz (cm) to X-ray (nm) </li><br>
							<li>located in Berlin Adlershof</li><br>
							<li>operated by the HZB</li>
						</ul>

					</div>
					</main>
			</section>

			<section class="title">
				<h1>BESSY II - A third generation light source</h1>
				<div class="grow grid g32">
					<img src="images/01-BESSY-II-floor-plan_zoom.svg" height="90%">
					<div class="flex-col space-evenly">
						<div data-markdown>
							Parameter | Value
							------------------ | -----------:
							nominal energy | 1.7 GeV
							beam current | 300 mA
							circumference | 240 m
							number of straights| 16
						</div>
						<div data-markdown>
							Lattice | Bunch length
							---------------------|-------:
							BESSY II | 15 ps
							BESSY II low alpha | 3 ps
							BESSY VSR short bunch| 1.7 ps
							BESSY VSR long bunch | 15 ps
						</div>
					</div>
				</div>
			</section>

			<section class="title">
				<h1>The Variable pulse-length Storage Ring</h1>
				<img class="grow" src="images/01-cavity-in-T2_graphic.svg">
				<p>One idea: Remove inner Quadrupoles to gain installation length</p>
				<img src="images/layout/BessyVSR_logo.svg" style="position: absolute; top: 1.5%; right: 1.5%; width : 20%;">
			</section>

			<section class="center">
				<h1>Transverse linear beam dynamics in circular accelerators</h1>
			</section>

			<section class="title space-between">
				<h1>Transverse linear beam dynamics in circular accelerators</h1>
				<p>
					The equations of motion for a charged particle in a magnetic field in linear order:
				</p>
				<div class="math">
					\begin{align}
					u''(s) + K(s) u(s) = 0 &&&\quad \overset{\text{Floquet's theorem}}{\Rightarrow} \quad &&u(s) = \sqrt{\epsilon}
					\sqrt{\beta(s)} \cos(\psi(s)+\psi_0)
					\end{align}
				</div>
				<img src="images/03-envelope.svg" width="100%">
			</section>

			<section class="title">
				<h1> Lattice stability </h1>

				<div class="grow flex-col space-evenly left">
					<p> Transformation of the Twissparameter: </p>

					$$\textbf{B}(s+L) = \textbf{R}(s,L) \cdot \textbf{B}(s) \cdot \textbf{R}^T(s,L) \quad \mathrm{with}\quad
					\textbf{B}(s) = \begin{pmatrix} \beta(s) & -\alpha(s) \\ -\alpha(s) & \gamma(s) \end{pmatrix}$$

					<p> Periodicity conditions of circular accelerators: </p>
					$$\beta(s) = \beta(s + C) \quad \forall \quad s$$

					<p> Intial value of the beta function: </p>
					$$\beta(s) = \frac{2 R_{12}}{\underbrace{\sqrt{2 - R_{11}^2 - 2 R_{12} R_{21} -
					R_{22}^2}}_{\overset{!}{>}0}}$$
				</div>
			</section>

			<section class="title space-between">
				<h1>Limits of the lattice stability - FODO cell</h1>
				<p>Stability condition:</p>
				$$2 - R_{11}^2 - 2 R_{12} R_{21} - R_{22}^2 > 0$$
				<div class="grid" style="grid-template-columns: 5fr 6fr;">
					<img src="images/05-necktie-plot.svg">
					<img src="images/05-limits-of-FODOcell.svg">
				</div>
			</section>

			<section class="title space-between">
				<h1>Scan for two quadrupoles of the BESSY II storage ring </h1>
				<img src="images/04-stability-plot-bessy2_Q3_vs_Q4_Q5_off_betamaxvalue.svg" height="65%">
				<h3>Challenges:</h3>
				<ol>
					<li>It is diffcult to find good <span class="hl1">initial paramters</span> for an optimization method:<br>
						â‡’ If the initial configuration is not stable, the optimizer is sort of <span class="hl1">"blind"</span>.
					</li>
					<br>
					<li>The discontinuity of the solution space complicates it to find <span class="hl1">global minima</span>:
						<br>
						â‡’ It needs a sophisticated optimization algorithm to "jump" between the stable regions.</li>
				</ol>
			</section>


			<section class="title center">
				<h1>The BESSY II Design lattice</h1>
				<div class="grid" style="grid-template-columns: 4fr 1fr">
					<img src="images/04-design-lattice-def.svg">
					<div data-markdown>
						Magnet | $k / \mathrm{m}^2$
						--- | ---:
						Q1 | +2.45190
						Q2 | -1.89757
						Q3D |-2.02025
						Q4D |+1.40816
						Q3T |-2.46319
						Q4T |+2.62081
						Q5T |-2.60000
					</div>
				</div>
			</section>





			<section class="title space-evenly">
				<h1>Task: Turn off the Q5T2 quadrupoles and keep current beta function</h1>
				<img src="images/01-cavity-in-T2_def.svg" alt="">
				<p style="text-align: center; font-size: 5em;">ðŸ ‹</p>
				<img src="images/01-cavity-in-T2_def_after.svg" alt="">
			</section>

			<section class="title space-evenly">
				<h1>First step: Finding a stable configuration</h1>
				<img src="images/01-cavity-in-T2_def.svg" alt="">
				<img src="images/05-stability-all_def_horizontal.svg" alt="">
			</section>



			<section class="title">
				<h1> Quadrupole scans and the curse of dimensionality </h1>
				<div class="flex-col">
					<img src="images/curse_of_dimensionality.png">
					<p style="text-align: center;"><i>The number of scan points grows exponentially with the degrees of
							freedom!</i></p>
				</div>
				Assuming
				<ul>
					<li>the calculation of the twiss parameter would take $t_1 = \mathrm{1 ms} $.</li>
					<li>a quadrupole scan in the neighborhood of $l = 1 \mathrm{m} ^{-2}$ with a steps size $\Delta k = 0.01
						\mathrm{m}^{-2}$</li>
				</ul>

				<p> A scan with the combination of $M = 6$ magnets would need </p>
				<div class="math">
					\begin{equation}
					t_{\mathrm{C}} = t_1 \cdot \left(\frac{l}{\Delta k}\right)^M = \mathrm{1 ms} \cdot
					\left(\frac{1}{0.01}\right)^6 \approx
					\mathrm{32 a} .
					\end{equation}
				</div>
			</section>

			<section class="title">
				<h1>Ratio of <span class="hl1">solution space</span> to <span class="hl2">scanned space</span></h1>
				<p> The ratio of the <span class="hl1">solution space</span> to the <span class="hl2">scanned space</span>
					strongly depends on the interval of the scan. </p>
				<img src="images/highdimensions_color.svg" style="height: 30%;">
				<p>Tested for a FODO cell</p>
				<div data-markdown>
					k-Interval | 2 DOF | 4 DOF
					----- | ---- |
					0.15 | 0.26 | 0.38
					0.25 | 0.30 | 0.20
					0.50 | 0.07 | 0.03
					0.75 | 0.04 | 0.01
				</div>
				<p>For higher dimensions it gets more difficult to choose a good scan interval. As the solutions space in
					general is unknown (and not continuous), this means that for higher dimensions more and more of the scanned
					area will not be a solution.</p>
			</section>




			<section class="title space-evenly">
				<h1>Optimization by minimization of a scalar function</h1>
				<div>
					<p> Objective function(al): </p>
					$$ F(\beta) = \frac{1}{L} \int_0^L R\left(\frac{\beta(s)}{\beta_{\mathrm{ref}}(s)}\right)\mathrm{d}s \quad \textrm{with } R(x) = \begin{cases} 1, &\textrm{for } x < 1\\ x, &\textrm{else} \end{cases} $$
				</div>
				<div class="flex grow center">
						<div>
							<h4>Two conditions:</h4>
							<ol>
								<li>The initial parameters must be stable.</li>
								<li>The optmization method has to handle the discontinuites.</li>
							</ol>
						</div>
						<img src="images/04-stability-plot-bessy2_Q3_vs_Q4_Q5_off_betamaxvalue.svg" width="50%">
				</div>
			</section>

			<section class="title">
				<h1>Optimizing with Python + Scipy</h1>
				<pre class="grow" style="font-size: 1em"><code data-trim data-noescape>
									def fitness(params):
										for element, attribute, param in zip(elements, attributes, params):
											setattr(element, attribute, param)
									
										twiss = lin.get_twiss()
									
										betaxres = twiss.betax_int / ref_twiss.betax_int
										betayres = twiss.betay_int / ref_twiss.betay_int
										betaxres[betaxres < 1] = 1
										betayres[betayres < 1] = 1
										betaxres = betaxres ** 4
										betayres = betayres ** 4
										beta_mean_res = np.mean([betaxres, betayres])
									return beta_mean_res
			
									scipy.optimize.minimize(fitness, initial_values)
										</code></pre>
			</section>


			<section class="title">
				<h1>Overview of solutions</h1>
				<div class="grid g23">
					<div data-markdown>
						Version | Used quadrupoles
						--- | ---
						V1 | T2
						V2 | D2, T2, D3
						V3 | T1, D2, T2, D3, T3
						V4 | D1, T1, D2, T2, D3, T3, D4
					</div>
					<img src="images/05-V-versions-comparison_def_2.svg" alt="">
				</div>
			</section>

			<section class="title">
				<h1>V1: The local solution</h1>
				<img class="grow" src="images/V1-comparison.svg" height="80%">
				<p style="text-align: center;">Comparison of the V1 lattice (solid) with the current standard lattice (dashed).
				</p>
			</section>


			<section class="title">
				<h1>V4: The best solution found</h1>
				<img class="grow" src="images/V4-comparison.svg" height="80%">
				<p style="text-align: center;">Comparison of the V4 lattice (solid) with the current standard lattice (dashed).
				</p>
			</section>

			<section class="title space-around">
				<h1>Testing V1-V4 at the machine</h1>
				<div class="grid g31">
					<img src="images/05-injection_efficiency_all_version_def.svg" alt="">
					<div data-markdown>
						Version | Injection efficiency
						---| ---:
						V1 | 79.5 %
						V2 | 89.0 %
						V3 | 93.2 %
						V4 | 96.5 %
					</div>
				</div>
				<p>Comparison of the mean injection efficiency of the different version for an optimized sextupole setting for
					the V4
					optics. The mean injection efficiency is marked with a red dashed line.</p>
			</section>


			<section class="title">
				<h1>The best solution V4: Simulation vs LOCO measurement</h1>
				<img class="grow" src="images/05-V4_LOCO_vs_SIM.svg" height="80%">
				<p style="text-align: center;">Comparison of V4 LOCO (solid) with V4 SIM (dashed).</p>
			</section>


			<section class="title">
				<h1>The best solution V4 compared to the current standard user optics</h1>
				<img class="grow" src="images/05-V4_vs_standard_loco.svg" height="80%">
				<p style="text-align: center;">The loco measured V4 optics (solid) in comparison to the standard optics
					(dashed).</p>
			</section>

			<section class="center">
				<h1> Conclusion and Outlook </h1>
			</section>

			<section class="title">
				<h1>Conclusion and Outlook</h1>
				<ul>
					<li>Optimization of the non-linear beam dynamics
						<div class="small">The sextupoles can be used to enhance the phase and momentum acceptance.</div>
					</li>
					<li>Better conversion of the quadrupole strengths</li>
					<div class="small">It would be very convenient to have conversion functions for the individual quadrupole
						families. These should be tested with LOCO to make sure that the simulated optics is transfered correctly to
						the machine.</div>
					<li>Test solutions with hardware modification</li>
					<div class="small">This thesis only considered solutions with existing hardware. Splitting up the quadrupole
						and sextupole families in the T2, D2 and D3 sections would increase the degrees of freedom. It has to be
						verified by simulations if this approach will lead to a better solution.</div>
					<li>A better optimization method</li>
					<div class="small">The used Nelder-Mead method is relatively slow and it has a weakness when considering local
						minima. Due to the increasing hype on machine learning, many new open source software libraries have been
						developed, which can be used to solve diverse optimization tasks. Their applicability to lattice
						optimization problems should be tested.</div>
				</ul>
			</section>

			<section class="center" data-background="#23373B">
				<h1>Questions?</h1>
			</section>

			<section class="center">
				<h1>Backups</h1>
			</section>

			<section class="title center">
				<h1>BESSY VSR - The variable pulse-length storage ring</h1>
				<div class="grid g31">
					<img src="images/01-cavity-voltage.svg" width="100%">
					<div data-markdown>
						Lattice | Bunch length
						---------------------|-------:
						BESSY II | 15 ps
						BESSY II low alpha | 3 ps
						BESSY VSR short bunch| 1.7 ps
						BESSY VSR long bunch | 15 ps
					</div>
				</div>
			</section>


			<section class="title space-between">
				<h1>Version 1</h1>
				Only using the Quadrupoles of the T2 straight to compensate the turn off of the Q5
				<img src="images/05-V1-comparison_def.svg" alt="">
				<div data-markdown>
					Magnet| Initial | Finial | Absolute | Relative | Relative (exp.)
					---- | ---- | --- | ----- | --- | ----
					Q5T2 | -2.588 | 0.000 | 2.588 | 0.000 | 0.080
					Q4T2 | 2.579 | 2.032 | -0.547 | 0.788 | 0.769
					Q3T2 | -2.455 | -2.630 | -0.174 | 1.071 | 1.031

					$\beta_{\mathrm{x,max}}$ / m | $\beta_{\mathrm{y,max}}$ / m | $\overline{\beta}_{\mathrm{x,rel}}$ / m |
					$\overline{\beta}_{\mathrm{y,rel}}$ / m
					--- | ---| --- | ---
					32.34 | 54.57 | 1.08 | 1.43
				</div>
			</section>

		</div>
	</div>

	<script src="reveal.js/lib/js/head.min.js"></script>
	<script src="reveal.js/js/reveal.js"></script>

	<script>
		// More info about config & dependencies:
		// - https://github.com/hakimel/reveal.js#configuration
		// - https://github.com/hakimel/reveal.js#dependencies
		Reveal.initialize({
			pdfMaxPagesPerSlide: 1,
			width: 1920,
			height: 1080,
			// height: 1400,
			center: false,
			margin: 0,

			history: true,
			controls: false,
			slideNumber: true,
			display: 'flex',

			// transition: 'fade',
			transition: 'none',
			backgroundTransition: 'fade',
			dependencies: [
				{ src: 'reveal.js/plugin/markdown/marked.js' },
				{ src: 'reveal.js/plugin/markdown/markdown.js' },
				{ src: 'reveal.js/plugin/notes/notes.js', async: true },
				{ src: 'reveal.js/plugin/highlight/highlight.js', async: true, callback: function () { hljs.initHighlightingOnLoad(); } },
				{ src: 'reveal.js/plugin/math/math.js' }
			]
		});
	</script>

	<!-- <script type="text/javascript">
		MathJax.Hub.Config({
			"HTML-CSS": {
				preferredFont: null,
				webFont: "Asana-Math",
			}
		});    
	</script> -->

</body>

</html>